rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // FUNÇÕES AUXILIARES DE VALIDAÇÃO
    // ============================================

    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usuário é o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Valida formato de email
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    // Valida tamanho de string
    function isValidStringLength(str, min, max) {
      return str is string && str.size() >= min && str.size() <= max;
    }

    // Valida CPF (11 dígitos numéricos)
    function isValidCPF(cpf) {
      return cpf is string && cpf.matches('^[0-9]{11}$');
    }

    // Valida CNPJ (14 dígitos numéricos)
    function isValidCNPJ(cnpj) {
      return cnpj is string && cnpj.matches('^[0-9]{14}$');
    }

    // Valida telefone (10-15 dígitos com código de país opcional)
    function isValidPhone(phone) {
      return phone is string && phone.matches('^\\+?[0-9]{10,15}$');
    }

    // Valida role válido
    function isValidRole(role) {
      return role in ['client', 'professional', 'owner'];
    }

    // Valida array de roles
    function hasValidRoles(roles) {
      return roles is list
        && roles.size() > 0
        && roles.size() <= 3;
    }

    // Valida URL (básico)
    function isValidURL(url) {
      return url is string && url.matches('^https?://.*');
    }

    // Valida timestamp
    function isValidTimestamp(ts) {
      return ts is timestamp;
    }

    // ============================================
    // COLEÇÃO: USERS
    // ============================================
    match /users/{userId} {
      // Leitura de documento específico: apenas usuários autenticados e o próprio usuário
      allow get: if request.auth != null && request.auth.uid == userId;

      // Lista/Query: permite queries limitadas para verificação de email (sem autenticação)
      // ou usuários autenticados podem ler
      allow list: if request.auth != null
        || (request.query.limit <= 1);  // Permite verificação de email existente

      // Escrita: apenas usuários autenticados
      allow write: if request.auth != null;
    }

    // ============================================
    // COLEÇÃO: PROFESSIONALS
    // ============================================
    match /professionals/{professionalId} {
      // Leitura: o próprio profissional ou donos de barbearias vinculadas
      allow read: if isAuthenticated() && (
        isOwner(professionalId)
        || exists(/databases/$(database)/documents/professionals/$(professionalId))
      );

      // Criação: apenas o próprio profissional
      allow create: if isOwner(professionalId)
        && request.resource.data.userId == professionalId
        && request.resource.data.isActive == true
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt)
        && request.resource.data.servicesCompleted == 0
        && request.resource.data.reviewsCount == 0
        && request.resource.data.rating == 0
        && (!request.resource.data.keys().hasAny(['cnpj']) || isValidCNPJ(request.resource.data.cnpj))
        && (!request.resource.data.keys().hasAny(['specialties']) || request.resource.data.specialties is list);

      // Atualização: apenas o próprio profissional (campos limitados)
      allow update: if isOwner(professionalId)
        && request.resource.data.userId == resource.data.userId  // userId imutável
        && request.resource.data.createdAt == resource.data.createdAt  // createdAt imutável
        && isValidTimestamp(request.resource.data.updatedAt)
        // Campos de estatísticas NÃO podem ser editados pelo cliente
        && request.resource.data.servicesCompleted == resource.data.servicesCompleted
        && request.resource.data.reviewsCount == resource.data.reviewsCount
        && request.resource.data.rating == resource.data.rating;

      // Deleção: não permitida
      allow delete: if false;
    }

    // ============================================
    // COLEÇÃO: OWNERS
    // ============================================
    match /owners/{ownerId} {
      // Leitura: apenas o próprio dono
      allow read: if isOwner(ownerId);

      // Criação: apenas o próprio dono
      allow create: if isOwner(ownerId)
        && request.resource.data.userId == ownerId
        && request.resource.data.businesses is list
        && request.resource.data.plan in ['free', 'basic', 'premium']
        && request.resource.data.subscriptionStatus in ['active', 'inactive', 'trial']
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt)
        && (!request.resource.data.keys().hasAny(['cnpj']) || isValidCNPJ(request.resource.data.cnpj));

      // Atualização: apenas o próprio dono (campos limitados)
      allow update: if isOwner(ownerId)
        && request.resource.data.userId == resource.data.userId  // userId imutável
        && request.resource.data.createdAt == resource.data.createdAt  // createdAt imutável
        && isValidTimestamp(request.resource.data.updatedAt)
        // Plano e status de assinatura NÃO podem ser editados pelo cliente
        && request.resource.data.plan == resource.data.plan
        && request.resource.data.subscriptionStatus == resource.data.subscriptionStatus;

      // Deleção: não permitida
      allow delete: if false;
    }

    // ============================================
    // COLEÇÃO: BUSINESSES (Barbearias)
    // ============================================
    match /businesses/{businessId} {
      // Leitura: público (listagem de barbearias) ou donos
      allow read: if isAuthenticated();

      // Criação: apenas donos (verificar role owner no users)
      allow create: if isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['owner'])
        && request.resource.data.ownerId == request.auth.uid
        && isValidStringLength(request.resource.data.name, 2, 100)
        && isValidStringLength(request.resource.data.description, 0, 500)
        && request.resource.data.status == 'active'
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt)
        && (!request.resource.data.keys().hasAny(['phone']) || isValidPhone(request.resource.data.phone))
        && (!request.resource.data.keys().hasAny(['photoURL']) || isValidURL(request.resource.data.photoURL))
        && request.resource.data.professionals is list
        && request.resource.data.rating >= 0 && request.resource.data.rating <= 5
        && request.resource.data.reviewsCount >= 0;

      // Atualização: apenas o dono da barbearia
      allow update: if isAuthenticated()
        && resource.data.ownerId == request.auth.uid
        && request.resource.data.ownerId == resource.data.ownerId  // ownerId imutável
        && request.resource.data.createdAt == resource.data.createdAt  // createdAt imutável
        && isValidTimestamp(request.resource.data.updatedAt)
        // Campos de estatísticas NÃO podem ser editados pelo cliente
        && request.resource.data.rating == resource.data.rating
        && request.resource.data.reviewsCount == resource.data.reviewsCount;

      // Deleção: apenas o dono (usar Cloud Function para limpeza adequada)
      allow delete: if isAuthenticated()
        && resource.data.ownerId == request.auth.uid;
    }

    // ============================================
    // COLEÇÃO: APPOINTMENTS (Agendamentos)
    // ============================================
    match /appointments/{appointmentId} {
      // Leitura: cliente, profissional ou dono da barbearia
      allow read: if isAuthenticated() && (
        resource.data.clientId == request.auth.uid
        || resource.data.professionalId == request.auth.uid
        || get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.ownerId == request.auth.uid
      );

      // Criação: apenas clientes autenticados
      allow create: if isAuthenticated()
        && request.resource.data.clientId == request.auth.uid
        && request.resource.data.status == 'pending'
        && isValidTimestamp(request.resource.data.scheduledAt)
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt)
        && request.resource.data.keys().hasAll(['businessId', 'professionalId', 'clientId', 'serviceId', 'status', 'scheduledAt']);

      // Atualização: cliente (cancelar), profissional ou dono (aprovar/rejeitar)
      allow update: if isAuthenticated() && (
        // Cliente pode cancelar
        (resource.data.clientId == request.auth.uid
          && request.resource.data.status == 'cancelled'
          && resource.data.status in ['pending', 'confirmed'])
        // Profissional ou dono pode aprovar/rejeitar
        || (resource.data.professionalId == request.auth.uid
          && request.resource.data.status in ['confirmed', 'rejected', 'completed'])
        || (get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.ownerId == request.auth.uid
          && request.resource.data.status in ['confirmed', 'rejected', 'completed'])
      ) && isValidTimestamp(request.resource.data.updatedAt);

      // Deleção: não permitida
      allow delete: if false;
    }

    // ============================================
    // COLEÇÃO: SERVICES (Serviços)
    // ============================================
    match /services/{serviceId} {
      // Leitura: público
      allow read: if isAuthenticated();

      // Criação: apenas donos de barbearia
      allow create: if isAuthenticated()
        && get(/databases/$(database)/documents/businesses/$(request.resource.data.businessId)).data.ownerId == request.auth.uid
        && isValidStringLength(request.resource.data.name, 2, 100)
        && isValidStringLength(request.resource.data.description, 0, 500)
        && request.resource.data.price > 0
        && request.resource.data.duration > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      // Atualização: apenas dono da barbearia
      allow update: if isAuthenticated()
        && get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.ownerId == request.auth.uid
        && request.resource.data.businessId == resource.data.businessId  // businessId imutável
        && request.resource.data.createdAt == resource.data.createdAt  // createdAt imutável
        && isValidTimestamp(request.resource.data.updatedAt);

      // Deleção: apenas dono da barbearia
      allow delete: if isAuthenticated()
        && get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.ownerId == request.auth.uid;
    }

    // ============================================
    // COLEÇÃO: REVIEWS (Avaliações)
    // ============================================
    match /reviews/{reviewId} {
      // Leitura: público
      allow read: if isAuthenticated();

      // Criação: apenas clientes que tiveram agendamento completado
      allow create: if isAuthenticated()
        && request.resource.data.clientId == request.auth.uid
        && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
        && isValidStringLength(request.resource.data.comment, 0, 500)
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      // Atualização: apenas o autor da avaliação (dentro de 24h)
      allow update: if isAuthenticated()
        && resource.data.clientId == request.auth.uid
        && request.resource.data.clientId == resource.data.clientId  // clientId imutável
        && request.resource.data.businessId == resource.data.businessId  // businessId imutável
        && request.resource.data.professionalId == resource.data.professionalId  // professionalId imutável
        && request.resource.data.createdAt == resource.data.createdAt  // createdAt imutável
        && isValidTimestamp(request.resource.data.updatedAt)
        && request.resource.data.rating >= 1 && request.resource.data.rating <= 5;

      // Deleção: não permitida (use Cloud Function)
      allow delete: if false;
    }

    // ============================================
    // COLEÇÃO: BUSINESS_PROFESSIONAL_LINKS
    // ============================================
    match /business_professional_links/{linkId} {
      // Leitura: profissional ou dono da barbearia
      allow read: if isAuthenticated() && (
        resource.data.professionalUid == request.auth.uid
        || get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.ownerId == request.auth.uid
      );

      // Criação: apenas via Cloud Function (validação de código)
      allow create: if false;

      // Atualização: apenas via Cloud Function
      allow update: if false;

      // Deleção: profissional ou dono da barbearia
      allow delete: if isAuthenticated() && (
        resource.data.professionalUid == request.auth.uid
        || get(/databases/$(database)/documents/businesses/$(resource.data.businessId)).data.ownerId == request.auth.uid
      );
    }

    // ============================================
    // COLEÇÃO: SESSIONS (Gestão de Sessões)
    // ============================================
    match /sessions/{sessionId} {
      // Leitura: apenas o próprio usuário pode ver suas sessões
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Criação: apenas via Cloud Function (createSession)
      // IMPORTANTE: Cloud Functions usam credenciais Admin e ignoram estas regras
      allow create: if false;

      // Atualização: apenas via Cloud Function (refreshSession, revokeSession)
      allow update: if false;

      // Deleção: apenas via Cloud Function ou o próprio usuário pode deletar sua sessão
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // COLEÇÃO: _RATE_LIMITS (Rate Limiting Interno)
    // ============================================
    match /_rate_limits/{docId} {
      // Leitura/Escrita: apenas via Cloud Function
      allow read, write: if false;
    }

    // ============================================
    // COLEÇÃO: _SECURITY_LOGS (Logs de Segurança)
    // ============================================
    match /_security_logs/{logId} {
      // Leitura/Escrita: apenas via Cloud Function
      allow read, write: if false;
    }

    // ============================================
    // REGRA DEFAULT: NEGAR TUDO
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
